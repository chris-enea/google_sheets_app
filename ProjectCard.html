<!-- Project Card Component -->
<script>
  /**
   * Create a project card element
   * @param {Object} project - Project data object
   * @return {HTMLElement} The project card DOM element
   */
  function createProjectCard(project) {
    const card = document.createElement('div');
    card.className = 'project-card';
    
    // Determine status class and text
    let statusClass = 'status-not-started';
    let statusText = 'Not Started';
    
    switch (project.status) {
      case 'In Progress':
        statusClass = 'status-on-track';
        statusText = 'In Progress';
        break;
      case 'On Hold':
        statusClass = 'status-delayed';
        statusText = 'On Hold';
        break;
      case 'Completed':
        statusClass = 'status-completed';
        statusText = 'Completed';
        break;
    }
    
    
    // Build card HTML
    card.innerHTML = `
      <div class="project-card-header">
        <h3>${project.name}</h3>
        <div class="project-card-status">
          <span class="status-indicator ${statusClass}"></span>
          <span>${statusText}</span>
        </div>
        <button class="project-edit-btn edit-project-btn" data-project-id="${project.id}" title="Edit Project">
          <i class="material-icons edit-icon">edit</i>
          <div class="button-loader"></div>
        </button>
      </div>
      <div class="project-card-content">
        <div>
          <p>
            <strong>Client:</strong><br>
            ${project.client || 'N/A'}  
            ${project.clientEmail ? `<span class="contact-email" data-email="${project.clientEmail}" title="Click to copy email">${project.clientEmail}</span>` : ''}
          </p>
          <p>
            <strong>Architect:</strong><br>
            ${project.architect || 'N/A'}
            ${project.architectEmail ? `<span class="contact-email" data-email="${project.architectEmail}" title="Click to copy email">${project.architectEmail}</span>` : ''}
          </p>
          <p>
            <strong>Contractor:</strong><br>
            ${project.contractor || 'N/A'}
            ${project.contractorEmail ? `<span class="contact-email" data-email="${project.contractorEmail}" title="Click to copy email">${project.contractorEmail}</span>` : ''}
          </p>
        </div>
        <div id="taskContainer-${project.id}" class="task-container collapsed" style="display: none;"></div>
      </div>
      <div class="project-card-actions">
        <button class="project-action-btn view-details-btn" data-project-id="${project.id}" data-sheet-id="${project.sheetId || ''}">View Details</button>
        <button class="project-action-btn view-tasks-btn" data-project-id="${project.id}" data-asana-id="${project.asanaProjectId ? project.asanaProjectId.replace(/["']/g, '') : ''}">View Tasks</button>
      </div>
    `;
    
    // Get the color from settings and apply to the header
    const header = card.querySelector('.project-card-header');
    
    // Use project-specific color if available, otherwise use global setting
    if (project.projectColor) {
      // Store the project color as a data attribute
      card.setAttribute('data-project-color', project.projectColor);
      header.style.setProperty('background-color', project.projectColor, 'important');
      header.style.setProperty('color', '#FFFFFF', 'important'); // Set text color to white for better contrast
    } else {
      // Fall back to global setting
      google.script.run.withSuccessHandler(function(data) {
        if (data.projectColor) {
          header.style.setProperty('background-color', data.projectColor, 'important');
          header.style.setProperty('color', '#FFFFFF', 'important'); // Set text color to white for better contrast
        }
      }).getSettings();
    }
    
    // Add event listener for the edit button to handle loading state
    const editBtn = card.querySelector('.edit-project-btn');
    editBtn.addEventListener('click', function(event) {
      
      
      // Prevent multiple clicks by adding loading state
      if (!this.classList.contains('loading')) {
        this.classList.add('loading');
      }
    });
    
    // Add event listener for the view tasks button
    const viewTasksBtn = card.querySelector('.view-tasks-btn');
    viewTasksBtn.addEventListener('click', function(event) {
      const projectId = this.getAttribute('data-project-id');
      const asanaProjectId = this.getAttribute('data-asana-id');
      const card = this.closest('.project-card');
      
      // Check if tasks are already loaded and visible
      const taskContainer = document.getElementById('taskContainer-' + projectId);
      if (taskContainer && taskContainer.style.display === 'block') {
        // Tasks are visible, so hide them
        taskContainer.style.display = 'none';
        this.textContent = 'View Tasks';
        card.removeAttribute('data-tasks-expanded');
        // Add the collapsed class back when hiding
        taskContainer.classList.add('collapsed');
        taskContainer.classList.remove('expanded');
        return;
      }
      
      // Skip if no Asana ID
      if (!asanaProjectId) {
        alert('This project does not have an Asana integration.');
        return;
      }
      
      // Clean the ID to remove any quotes
      const cleanAsanaId = asanaProjectId.replace(/["']/g, '').trim();
      
      // Store reference to the button for use in the callback
      const button = this;
      
      // Show loading overlay
      const loadingEl = document.getElementById('dashboardLoadingOverlay');
      if (loadingEl) {
        loadingEl.style.display = 'flex';
        document.getElementById('dashboardLoadingMessage').textContent = 'Loading Asana tasks...';
      }
      
      // Fetch tasks from Asana
      google.script.run
        .withSuccessHandler(function(result) {
          // Hide loading overlay
          if (loadingEl) loadingEl.style.display = 'none';
          
          // Show tasks using renderTasks function
          if (result.success) {
            // Create a container for tasks if it doesn't exist
            let taskContainer = document.getElementById('taskContainer-' + projectId);
            if (!taskContainer) {
              taskContainer = document.createElement('div');
              taskContainer.id = 'taskContainer-' + projectId;
              taskContainer.className = 'task-container';
              
              // Find the project card content to append to
              const cardContent = card.querySelector('.project-card-content');
              if (cardContent) {
                cardContent.appendChild(taskContainer);
              }
            }
            
            // Show the container
            taskContainer.style.display = 'block';
            
            // Mark card as expanded
            card.setAttribute('data-tasks-expanded', 'true');
            
            // Remove the collapsed class to make the container visible
            taskContainer.classList.remove('collapsed');
            taskContainer.classList.add('expanded');
            
            // Render the tasks
            renderTasks(result, taskContainer.id);
            
            // Update button text - using the captured reference
            button.textContent = 'Hide Tasks';
          } else {
            alert('Error: ' + (result.error || 'Could not fetch tasks'));
          }
        })
        .withFailureHandler(function(error) {
          // Hide loading overlay
          if (loadingEl) loadingEl.style.display = 'none';
          alert('Error: ' + error);
        })
        .getAsanaTasksForProject(cleanAsanaId);
    });
    
    return card;
  }

  // Helper function to open settings (fallback if not defined elsewhere)
  function openSettings() {
    if (typeof window.openSettingsModal === 'function') {
      window.openSettingsModal();
    } else {
      alert('Settings functionality is not available in this view.');
    }
  }
  
  // Add event listener for copying email to clipboard
  document.addEventListener('click', function(event) {
    if (event.target.classList.contains('contact-email')) {
      const email = event.target.getAttribute('data-email');
      copyToClipboard(email);
      
      // Show feedback
      const originalTitle = event.target.title;
      event.target.title = 'Copied!';
      event.target.classList.add('copied');
      
      // Reset after 2 seconds
      setTimeout(function() {
        event.target.title = originalTitle;
        event.target.classList.remove('copied');
      }, 2000);
    }
  });
  
  // Function to copy text to clipboard
  function copyToClipboard(text) {
    // Create a temporary textarea element
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.setAttribute('readonly', '');
    textarea.style.position = 'absolute';
    textarea.style.left = '-9999px';
    document.body.appendChild(textarea);
    
    // Select and copy the text
    textarea.select();
    document.execCommand('copy');
    
    // Remove the textarea
    document.body.removeChild(textarea);
  }

  // Function to filter sidebar tasks by open/completed
  function filterTasks() {
        const showOnlyOpen = document.getElementById('showOnlyOpenTasksCheckbox');
        if (!sidebarTasksResult) return;
        const result = JSON.parse(JSON.stringify(sidebarTasksResult)); // Deep copy to avoid mutating original
        if (showOnlyOpen && showOnlyOpen.checked) {
          // Filter out completed tasks in each section
          Object.keys(result.tasks).forEach(section => {
            result.tasks[section] = result.tasks[section].filter(task => !task.completed);
          });
        }
        // Re-render the sidebar with the filtered result
        renderTasks(result);
      }

      // Helper to render the sidebar tasks (used by both displayTasks and filterSidebarTasks)
      function renderTasks(result, containerId) {
        const taskContainer = document.getElementById(containerId || '');
        // Clear the current content
        if (!taskContainer) return;
        
        taskContainer.innerHTML = '';
        const fragment = document.createDocumentFragment();
        if (!result.success) {
          if (result.error && result.error.includes("credentials not configured")) {
            const infoBox = document.createElement('div');
            infoBox.className = 'info-box';
            const infoText = document.createElement('p');
            infoText.textContent = 'Asana integration not configured.';
            const configButton = document.createElement('button');
            configButton.className = 'btn btn-outline';
            configButton.style.marginTop = '8px';
            configButton.addEventListener('click', openSettings);
            const configIcon = document.createElement('i');
            configIcon.className = 'material-icons';
            configIcon.textContent = 'settings';
            configButton.appendChild(configIcon);
            configButton.appendChild(document.createTextNode(' Configure Asana'));
            infoBox.appendChild(infoText);
            infoBox.appendChild(configButton);
            fragment.appendChild(infoBox);
          } else {
            const errorBox = document.createElement('div');
            errorBox.className = 'error-box';
            const errorStrong = document.createElement('strong');
            errorStrong.textContent = 'Error:';
            errorBox.appendChild(errorStrong);
            errorBox.appendChild(document.createTextNode(' ' + (result.error || 'Failed to load tasks')));
            fragment.appendChild(errorBox);
          }
          taskContainer.appendChild(fragment);
          return;
        }
        
        // Ensure the container is properly visible
        taskContainer.style.display = 'block';
        taskContainer.classList.remove('collapsed');
        taskContainer.classList.add('expanded');
        
        if (!result.tasks || Object.keys(result.tasks).length === 0) {
          const emptyState = document.createElement('div');
          emptyState.className = 'empty-state';
          const emptyIcon = document.createElement('i');
          emptyIcon.className = 'material-icons';
          emptyIcon.textContent = 'task_alt';
          const emptyText = document.createElement('p');
          emptyText.textContent = 'No tasks found';
          emptyState.appendChild(emptyIcon);
          emptyState.appendChild(emptyText);
          fragment.appendChild(emptyState);
          taskContainer.appendChild(fragment);
          return;
        }
        const sectionNames = result.sectionOrder || Object.keys(result.tasks);
        sectionNames.forEach(sectionName => {
          if (!result.tasks[sectionName]) return;
          const tasks = result.tasks[sectionName];
          if (tasks.length === 0) return;
          const sectionHeader = document.createElement('div');
          sectionHeader.className = 'toggle-header';
          const sectionIcon = document.createElement('i');
          sectionIcon.className = 'material-icons';
          sectionIcon.textContent = 'view_list';
          sectionHeader.appendChild(sectionIcon);
          sectionHeader.appendChild(document.createTextNode(' ' + sectionName));
          fragment.appendChild(sectionHeader);
          const taskList = document.createElement('div');
          taskList.className = 'task-list';
          tasks.forEach(task => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const taskItem = document.createElement('div');
            taskItem.className = task.completed ? 'task-item completed-task' : 'task-item';
            const taskIcon = document.createElement('i');
            taskIcon.className = 'material-icons task-icon';
            taskIcon.textContent = task.completed ? 'check_circle' : 'check_circle_outline';
            const taskContent = document.createElement('div');
            taskContent.className = 'task-content';
            const taskLink = document.createElement('a');
            taskLink.href = task.url;
            taskLink.target = '_blank';
            taskLink.style.color = 'inherit';
            taskLink.style.textDecoration = 'none';
            taskLink.style.display = 'block';
            const taskName = document.createElement('div');
            taskName.className = 'task-name';
            taskName.textContent = task.name;
            const taskMeta = document.createElement('div');
            taskMeta.className = 'task-meta';
            if (task.dueDate) {
              const dueDate = new Date(task.dueDate);
              dueDate.setHours(0, 0, 0, 0);
              const formattedDate = `${dueDate.getMonth() + 1}/${dueDate.getDate()}/${dueDate.getFullYear()}`;
              const dateSpan = document.createElement('span');
              dateSpan.className = 'task-date';
              dateSpan.textContent = formattedDate;
              if (!task.completed) {
                const timeDiff = dueDate.getTime() - today.getTime();
                const daysDiff = timeDiff / (1000 * 3600 * 24);
                if (daysDiff < 0) {
                  dateSpan.classList.add('late-task');
                } else if (daysDiff <= 3) {
                  dateSpan.classList.add('soon-task');
                }
              }
              taskMeta.appendChild(dateSpan);
            }
            if (task.assignee) {
              const assigneeSpan = document.createElement('span');
              assigneeSpan.className = 'task-assignee';
              assigneeSpan.textContent = task.assignee;
              taskMeta.appendChild(assigneeSpan);
            }
            taskLink.appendChild(taskName);
            taskLink.appendChild(taskMeta);
            taskContent.appendChild(taskLink);
            taskItem.appendChild(taskIcon);
            taskItem.appendChild(taskContent);
            taskList.appendChild(taskItem);
          });
          fragment.appendChild(taskList);
        });
        taskContainer.appendChild(fragment);
      }
</script> 

<!-- Task Container Styles -->
<style>
  .task-container {
    background-color: #f9f9f9;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    width: 100%;
    overflow-y: scroll;
    transition: all 0.3s ease;
    margin-top: 10px; /* Add space between client info and tasks */
  }
  
  /* Client email styles */
  .contact-email {
    margin-left: 5px;
    color: #666;
    font-size: 0.9em;
    cursor: pointer;
    transition: all 0.2s ease;
    padding: 2px 4px;
    border-radius: 3px;
  }
  
  .contact-email:hover {
    background-color: rgba(38, 113, 125, 0.1);
    color: #26717D;
  }
  
  .contact-email.copied {
    background-color: rgba(76, 175, 80, 0.2);
  }
  
  /* Make task items slightly more compact */
  .task-item {
    padding: 5px 10px;
  }
  
  /* Make section headers smaller */
  .toggle-header {
    padding: 6px 10px;
    font-size: 13px;
  }
  
  /* Add some animation for expand/collapse */
  .task-container.expanded {
    max-height: 300px; /* Limit height to trigger scrolling */
    min-height: 50px; /* Ensure a minimum height for visibility */
    opacity: 1;
    padding: 10px;
    margin-top: 10px;
    overflow-y: auto;
  }
  
  .task-container.collapsed {
    max-height: 0;
    opacity: 0;
    padding: 0;
    margin: 0;
    overflow: hidden;
  }
  
  /* Style the scrollbar */
  .task-container::-webkit-scrollbar {
    width: 6px;
  }
  
  .task-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
  }
  
  .task-container::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 10px;
  }
  
  .task-container::-webkit-scrollbar-thumb:hover {
    background: #26717D;
  }
  
  /* Ensure project card can expand */
  .project-card {
    transition: all 0.3s ease;
    height: auto; /* Allow height to adjust normally */
    display: flex;
    flex-direction: column;
    position: relative; /* Create positioning context */
  }
  
  /* Only the card with expanded tasks should grow */
  .project-card[data-tasks-expanded="true"] {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 1; /* Give it a higher z-index */
  }
  
  .project-card-content {
    transition: all 0.3s ease;
    position: relative; /* Create positioning context */
  }
</style> 